<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>TikTok Racing Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
    }
    /* üí° –ö–Ω–æ–ø–∫–∏ –ø–æ–≤–µ—Ä—Ö –∫–∞–Ω–≤–∞—Å–∞ */
    .donate-buttons {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    .donate-buttons button {
      margin: 3px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <!-- üí° –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∞ -->
  <div class="donate-buttons">
    <button onclick="testDonation(0)">üöó –î–æ–Ω–∞—Ç –¥–ª—è car1</button>
    <button onclick="testDonation(1)">üöó –î–æ–Ω–∞—Ç –¥–ª—è car2</button>
    <button onclick="testDonation(2)">üöó –î–æ–Ω–∞—Ç –¥–ª—è car3</button>
    <button onclick="testDonation(3)">üöó –î–æ–Ω–∞—Ç –¥–ª—è car4</button>
    <button onclick="testDonation(4)">üöó –î–æ–Ω–∞—Ç –¥–ª—è car5</button>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Ä–æ–≥—É
    const road = new Image();
    road.src = "road.png";

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Ä–æ–≥–∏
    let roadX = 0;
    const roadSpeed = 2.5; // ‚öôÔ∏è ‚Üê —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –¥–æ—Ä–æ–≥–∏

    // –ú–∞—à–∏–Ω–∫–∏
    const cars = [
      { img: Object.assign(new Image(), { src: "car1.png" }), x: 100, y: 185, width: 160, height: 80 },
      { img: Object.assign(new Image(), { src: "car2.png" }), x: 100, y: 240, width: 150, height: 200},
      { img: Object.assign(new Image(), { src: "car3.png" }), x: 100, y: 420, width: 160, height: 100 },
      { img: Object.assign(new Image(), { src: "car4.png" }), x: 100, y: 540, width: 160, height: 60 },
      { img: Object.assign(new Image(), { src: "car5.png" }), x: 110, y: 650, width: 160, height: 80 }
    ];

    // –ü—Ä–∏–≤—è–∑–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ –∫ –º–∞—à–∏–Ω–∫–∞–º
    const giftToCar = {
      "Rose": 0,       // üåπ  ‚Äî car1
      "TikTok": 1,     // üéµ  ‚Äî car2
      "GG": 2,         // üèÅ  ‚Äî car3
      "Squirrel": 3,   // üêøÔ∏è ‚Äî car4
      "Pumpkin": 4     // üéÉ  ‚Äî car5
    };

    function draw() {
      // –î–≤–∏–≥–∞–µ–º –¥–æ—Ä–æ–≥—É –≤–ª–µ–≤–æ
      roadX -= roadSpeed;
      if (roadX <= -road.width) roadX = 0;

      // –†–∏—Å—É–µ–º –¥–≤–µ –¥–æ—Ä–æ–≥–∏ –ø–æ–¥—Ä—è–¥ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –±–µ–ª—ã—Ö –∑–∞–∑–æ—Ä–æ–≤)
      ctx.drawImage(road, roadX, 0, road.width, canvas.height);
      ctx.drawImage(road, roadX + road.width, 0, road.width, canvas.height);

      // –†–∏—Å—É–µ–º –º–∞—à–∏–Ω–∫–∏
      cars.forEach(car => {
        ctx.drawImage(car.img, car.x, car.y, car.width, car.height);
      });

      requestAnimationFrame(draw);
    }

    road.onload = draw;

    // üöó –ê–Ω–∏–º–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –º–∞—à–∏–Ω–∫–∏
    function moveCarForward(carIndex) {
      const car = cars[carIndex];
      const distance = 50;   // ‚öôÔ∏è ‚Üê –Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–∞–ª–µ–∫–æ –µ–¥–µ—Ç –ø—Ä–∏ –¥–æ–Ω–∞—Ç–µ
      const duration = 300;  // ‚öôÔ∏è ‚Üê —Å–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ (–º–µ–Ω—å—à–µ = –±—ã—Å—Ç—Ä–µ–µ)
      const startX = car.x;
      const targetX = startX + distance;
      const startTime = performance.now();

      function animate() {
        const t = (performance.now() - startTime) / duration;
        if (t < 1) {
          car.x = startX + distance * t;
          requestAnimationFrame(animate);
        } else {
          car.x = targetX;

          const finishX = canvas.width -5;

          if (car.x >= finishX) {
          car.x = 130;

           // ‚úÖ +1 –æ—á–∫–æ –º–∞—à–∏–Ω–µ
          car.score = (car.score || 0) + 1;
          localStorage.setItem("car" + (carIndex + 1) + "_score", car.score);
        }
        }
      }

      animate();
    }

    // üéß –ü–æ–¥–∫–ª—é—á–∞–µ–º TikFinity
    const socket = new WebSocket("ws://localhost:21213/");

    socket.onopen = () => {
      console.log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ TikFinity");
    };

    socket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      console.log("üì©", message);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏–µ "gift"
      if (message.event === "gift") {
        const giftName = message.data?.giftName;
        console.log("üéÅ –ü–æ–ª—É—á–µ–Ω –ø–æ–¥–∞—Ä–æ–∫:", giftName);

        const carIndex = giftToCar[giftName];
        if (carIndex !== undefined) {
          moveCarForward(carIndex);
        } else {
          console.log("‚õî –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫:", giftName);
        }
      }
    };

    socket.onerror = (err) => {
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ TikFinity:", err);
    };

    // üí° —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∞
    function testDonation(carIndex) {
      moveCarForward(carIndex);
    }
  </script>
</body>
</html>


